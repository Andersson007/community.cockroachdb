####################################################################
# WARNING: These are designed specifically for Ansible tests       #
# and should not be used as examples of how to write Ansible roles #
####################################################################

# Test code for mysql_info module
# Copyright: (c) 2021, Andrew Klychkov (@Andersson007) <aaklychkov@mail.ru>
# GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)

- vars:
    conn_parameters: &conn_params
      ssl_mode: verify-full
      ssl_root_cert: '{{ ssl_root_cert }}'
      ssl_cert: '{{ ssl_cert }}'
      ssl_key: '{{ ssl_key }}'
    task_parameters: &task_params
      register: result

  block:

  - name: Check connection
    <<: *task_params
    cockroachdb_query:
      <<: *conn_params
      query: 'SELECT VERSION()'

  - name: Check
    assert:
      that:
      - result is changed
      - result.query == 'SELECT VERSION()'
      - result.statusmessage == 'SELECT 1'
      - result.rowcount == 1
      - result.query_result.0.0 is search('CockroachDB')


  - name: Create test database
    <<: *task_params
    cockroachdb_query:
      <<: *conn_params
      query: 'CREATE DATABASE test_db'

  - name: Check
    assert:
      that:
      - result is changed
      - result.query == 'CREATE DATABASE test_db'
      - result.statusmessage == 'CREATE DATABASE'
      - result.rowcount == -1
      - result.query_result == []


  - name: Create test table
    <<: *task_params
    cockroachdb_query:
      <<: *conn_params
      query: 'CREATE TABLE test_db.test_table (id int, story text)'

  - name: Check
    assert:
      that:
      - result is changed
      - result.query == 'CREATE TABLE test_db.test_table (id int, story text)'
      - result.statusmessage == 'CREATE TABLE'
      - result.rowcount == -1
      - result.query_result == []

