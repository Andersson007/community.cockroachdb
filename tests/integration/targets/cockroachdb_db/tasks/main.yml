####################################################################
# WARNING: These are designed specifically for Ansible tests       #
# and should not be used as examples of how to write Ansible roles #
####################################################################

# Test code for cockroachdb_db module
# Copyright: (c) 2022, Andrew Klychkov (@Andersson007) <aaklychkov@mail.ru>
# GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)

- vars:
    conn_parameters: &conn_params
      ssl_mode: verify-full
      ssl_root_cert: '{{ ssl_root_cert }}'
      ssl_cert: '{{ ssl_cert }}'
      ssl_key: '{{ ssl_key }}'
    task_parameters: &task_params
      register: result

  block:
  - name: Create database in check mode
    <<: *task_params
    cockroachdb_db:
      <<: *conn_params
      name: root
      state: present
    check_mode: yes

  - name: Check
    assert:
      that:
        - result is changed

  # TODO: Add check by cockroachdb_query later

  - name: Drop database in check mode
    <<: *task_params
    cockroachdb_db:
      <<: *conn_params
      name: root
      state: absent
    check_mode: yes

  - name: Check
    assert:
      that:
        - result is not changed

  - name: Create database
    <<: *task_params
    cockroachdb_db:
      <<: *conn_params
      name: root
      state: present

  - name: Check
    assert:
      that:
        - result is changed

  - name: Create database again
    <<: *task_params
    cockroachdb_db:
      <<: *conn_params
      name: root
      state: present

  - name: Check nothing changes
    assert:
      that:
        - result is not changed

  ####################
  # Check owner change
  - name: Create user
    <<: *task_params
    cockroachdb_query:
      <<: *conn_params
      query: CREATE USER IF NOT EXISTS test_user

  - name: Change owner in check mode
    <<: *task_params
    cockroachdb_db:
      <<: *conn_params
      name: root
      state: present
      owner: test_user
    check_mode: yes

  - name: Check
    assert:
      that:
        - result is changed

  # TODO: Add check by cockroachdb_query later

  - name: Change owner in real mode
    <<: *task_params
    cockroachdb_db:
      <<: *conn_params
      name: root
      state: present
      owner: test_user

  - name: Check
    assert:
      that:
        - result is changed

  # TODO: Add check by cockroachdb_query later

  - name: Change owner again in check mode
    <<: *task_params
    cockroachdb_db:
      <<: *conn_params
      name: root
      state: present
      owner: test_user
    check_mode: yes

  - name: Check
    assert:
      that:
        - result is not changed

  - name: Change owner again in real mode
    <<: *task_params
    cockroachdb_db:
      <<: *conn_params
      name: root
      state: present
      owner: test_user
    check_mode: yes

  - name: Check
    assert:
      that:
        - result is not changed

  #####################
  # test drop database

  - name: Drop database in check mode
    <<: *task_params
    cockroachdb_db:
      <<: *conn_params
      name: root
      state: absent
    check_mode: yes

  - name: Check
    assert:
      that:
        - result is changed

  # TODO: Add check by cockroachdb_query later

  - name: Drop database
    <<: *task_params
    cockroachdb_db:
      <<: *conn_params
      name: root
      state: absent

  - name: Check
    assert:
      that:
        - result is changed

  # TODO: Add check by cockroachdb_query later
